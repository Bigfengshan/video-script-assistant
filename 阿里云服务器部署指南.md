# 阿里云服务器部署指南 (Ubuntu 系统)

## 📋 系统要求

本指南专门针对 **Ubuntu 22.04 LTS** 系统编写，提供完整的项目部署流程。

**系统确认：**

```bash
# 确认系统版本
lsb_release -a

# 更新系统
sudo apt update && sudo apt upgrade -y
```

> 💡 **提示**: 如果您的服务器不是Ubuntu系统，建议重新创建实例并选择Ubuntu 22.04 LTS系统。

***

## 1. 服务器配置要求

### 推荐配置

* **实例规格**: ecs.c-c1m1.large (2 vCPU, 2 GiB内存) 或更高

* **操作系统**: **Ubuntu 22.04 LTS 64位**

* **存储**: 至少40GB系统盘

* **网络**: 3Mbps带宽起步

* **地域**: 选择离用户最近的地域（如华北2-北京）

### Ubuntu 22.04 LTS 优势

* ✅ 长期支持版本，稳定可靠

* ✅ apt包管理器简单易用

* ✅ 社区支持丰富，文档完善

* ✅ Docker和Node.js支持良好

* ✅ 安全更新及时，维护成本低

## 2. 服务器初始化配置

### 2.1 连接服务器

```bash
# 使用SSH连接服务器（替换your_server_ip为实际IP）
ssh root@your_server_ip
```

### 2.2 验证系统信息

```bash
# 查看系统版本
lsb_release -a

# 查看系统详细信息
cat /etc/os-release

# 查看内核版本
uname -r
```

### 2.3 系统更新和基础工具安装

```bash
# 更新软件包列表
sudo apt update

# 升级系统
sudo apt upgrade -y

# 安装基础工具
sudo apt install -y curl wget git vim htop unzip build-essential

# 安装网络和系统工具
sudo apt install -y net-tools ufw software-properties-common apt-transport-https ca-certificates gnupg lsb-release

# 验证安装
which curl git vim
```

### 2.4 创建非root用户

```bash
# 创建新用户（会提示设置密码和用户信息）
sudo adduser deploy

# 添加sudo权限
sudo usermod -aG sudo deploy

# 验证用户创建成功
id deploy

# 切换到新用户
su - deploy

# 验证sudo权限
sudo whoami
```

### 2.5 配置SSH密钥（推荐）

```bash
# 在本地生成SSH密钥对
ssh-keygen -t rsa -b 4096 -C "your_email@example.com"

# 将公钥复制到服务器
ssh-copy-id deploy@your_server_ip
```

## 3. 安全配置

### 3.1 配置UFW防火墙

```bash
# 重置防火墙规则（可选）
sudo ufw --force reset

# 设置默认策略
sudo ufw default deny incoming
sudo ufw default allow outgoing

# 允许SSH（重要：先设置SSH规则再启用防火墙）
sudo ufw allow ssh
sudo ufw allow 22/tcp

# 允许HTTP和HTTPS
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# 允许应用端口
sudo ufw allow 3000/tcp

# 启用防火墙
sudo ufw enable

# 查看防火墙状态
sudo ufw status verbose

# 查看编号规则（便于后续管理）
sudo ufw status numbered
```

### 3.2 配置SSH安全

```bash
# 备份原始配置
sudo cp /etc/ssh/sshd_config /etc/ssh/sshd_config.backup

# 编辑SSH配置
sudo vim /etc/ssh/sshd_config

# 推荐的安全配置：
# Port 22                          # 可以改为其他端口
# PermitRootLogin no               # 禁止root直接登录
# PasswordAuthentication yes       # 如果使用密钥可设为no
# PubkeyAuthentication yes         # 启用密钥认证
# MaxAuthTries 3                   # 最大认证尝试次数
# ClientAliveInterval 300          # 客户端存活检测间隔
# ClientAliveCountMax 2            # 最大存活检测次数

# 测试配置文件语法
sudo sshd -t

# 重启SSH服务
sudo systemctl restart ssh

# 验证SSH服务状态
sudo systemctl status ssh
```

### 3.3 阿里云安全组配置

在阿里云控制台配置安全组规则：

* 入方向：允许22(SSH)、80(HTTP)、443(HTTPS)、3000(应用端口)

* 出方向：允许所有

## 4. 环境安装

### 4.1 安装Node.js

```bash
# 方法1：使用NodeSource官方源（推荐）
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# 方法2：使用snap安装（备选）
# sudo snap install node --classic

# 验证安装
node --version
npm --version

# 配置npm全局包路径（避免权限问题）
mkdir ~/.npm-global
npm config set prefix '~/.npm-global'
echo 'export PATH=~/.npm-global/bin:$PATH' >> ~/.bashrc
source ~/.bashrc

# 安装常用全局包
npm install -g pnpm pm2 yarn

# 验证全局包安装
pnpm --version
pm2 --version
```

### 4.2 安装Docker

```bash
# 卸载旧版本Docker（如果存在）
sudo apt-get remove docker docker-engine docker.io containerd runc

# 安装依赖
sudo apt-get update
sudo apt-get install -y apt-transport-https ca-certificates curl gnupg lsb-release

# 添加Docker官方GPG密钥
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg

# 添加Docker源
echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

# 安装Docker Engine
sudo apt-get update
sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin

# 启动Docker服务
sudo systemctl start docker
sudo systemctl enable docker

# 将当前用户添加到docker组
sudo usermod -aG docker $USER

# 重新登录或执行以下命令使组权限生效
newgrp docker

# 验证安装
docker --version
docker compose version
sudo docker run hello-world
```

### 4.3 安装Nginx

```bash
# 安装Nginx
sudo apt update
sudo apt install -y nginx

# 启动并设置开机自启
sudo systemctl start nginx
sudo systemctl enable nginx

# 检查Nginx状态
sudo systemctl status nginx

# 测试Nginx配置
sudo nginx -t

# 查看Nginx版本
nginx -v

# 设置防火墙允许Nginx
sudo ufw allow 'Nginx Full'

# 验证Nginx是否正常运行
curl -I http://localhost

# 查看Nginx进程
ps aux | grep nginx
```

## 5. 项目部署

### 5.1 上传项目代码

```bash
# 方法1：使用Git克隆
cd /home/deploy
git clone https://github.com/your-username/your-project.git
cd your-project

# 方法2：使用scp上传（在本地执行）
scp -r ./your-project deploy@your_server_ip:/home/deploy/
```

### 5.2 安装项目依赖

```bash
# 进入项目目录
cd /home/deploy/your-project

# 安装依赖
npm install
# 或者使用pnpm
pnpm install
```

### 5.3 配置环境变量

```bash
# 创建环境变量文件
cp .env.example .env
vim .env

# 配置以下变量：
# NODE_ENV=production
# PORT=3000
# SUPABASE_URL=your_supabase_url
# SUPABASE_ANON_KEY=your_supabase_anon_key
# SUPABASE_SERVICE_ROLE_KEY=your_supabase_service_role_key
```

### 5.4 构建项目

```bash
# 构建前端
npm run build

# 如果有后端API，确保API服务正常
npm run start:api
```

## 6. 数据库配置

### 6.1 使用Supabase（推荐）

**为什么选择Supabase：**

* ✅ 免费额度充足，适合中小型项目

* ✅ 自带认证系统，无需额外开发

* ✅ 实时数据库功能

* ✅ 自动备份和扩展

* ✅ 无需服务器维护

```bash
# 在项目根目录创建.env文件
cd /home/deploy/your-project
vim .env

# 添加Supabase配置
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_ANON_KEY=your_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key
NODE_ENV=production
PORT=3000
```

### 6.2 本地PostgreSQL（可选）

> 💡 **注意**: 只有在特殊需求下才建议使用本地数据库，Supabase已能满足大部分需求。

```bash
# 安装PostgreSQL
sudo apt update
sudo apt install -y postgresql postgresql-contrib

# 启动并启用服务
sudo systemctl start postgresql
sudo systemctl enable postgresql

# 检查服务状态
sudo systemctl status postgresql

# 设置postgres用户密码
sudo passwd postgres

# 创建应用数据库和用户
sudo -u postgres psql

-- 在PostgreSQL命令行中执行：
CREATE DATABASE your_app_db;
CREATE USER your_app_user WITH PASSWORD 'your_strong_password';
GRANT ALL PRIVILEGES ON DATABASE your_app_db TO your_app_user;
ALTER USER your_app_user CREATEDB;
\q

# 配置PostgreSQL允许本地连接
sudo vim /etc/postgresql/14/main/pg_hba.conf
# 找到并修改：
# local   all             all                                     md5

# 重启PostgreSQL
sudo systemctl restart postgresql

# 测试连接
psql -h localhost -U your_app_user -d your_app_db
```

## 7. Nginx反向代理配置

### 7.1 创建Nginx配置文件

```bash
sudo vim /etc/nginx/sites-available/your-app
```

### 7.2 配置内容

```nginx
server {
    listen 80;
    server_name your-domain.com www.your-domain.com;

    # 静态文件
    location / {
        root /home/deploy/your-project/dist;
        try_files $uri $uri/ /index.html;
        index index.html;
    }

    # API代理
    location /api/ {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # 日志
    access_log /var/log/nginx/your-app.access.log;
    error_log /var/log/nginx/your-app.error.log;
}
```

### 7.3 启用配置

```bash
# 创建软链接
sudo ln -s /etc/nginx/sites-available/your-app /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重启Nginx
sudo systemctl restart nginx
```

## 8. SSL证书配置

### 8.1 安装Certbot

```bash
# 安装Certbot
sudo apt install -y certbot python3-certbot-nginx
```

### 8.2 获取SSL证书

```bash
# 获取证书（替换your-domain.com）
sudo certbot --nginx -d your-domain.com -d www.your-domain.com

# 设置自动续期
sudo crontab -e
# 添加以下行：
0 12 * * * /usr/bin/certbot renew --quiet
```

## 9. 进程管理

### 9.1 使用PM2管理Node.js应用

```bash
# 安装PM2
npm install -g pm2

# 创建PM2配置文件
vim ecosystem.config.js
```

### 9.2 PM2配置文件

```javascript
module.exports = {
  apps: [{
    name: 'your-app-api',
    script: './api/server.js',
    instances: 'max',
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    },
    error_file: './logs/err.log',
    out_file: './logs/out.log',
    log_file: './logs/combined.log',
    time: true
  }]
};
```

### 9.3 启动应用

```bash
# 启动应用
pm2 start ecosystem.config.js

# 保存PM2配置
pm2 save

# 设置开机自启
pm2 startup
sudo env PATH=$PATH:/usr/bin /usr/lib/node_modules/pm2/bin/pm2 startup systemd -u deploy --hp /home/deploy
```

## 10. 域名配置

### 10.1 域名解析

在域名服务商处添加A记录：

* 主机记录：@ 或 www

* 记录类型：A

* 记录值：服务器公网IP

* TTL：600

### 10.2 验证域名解析

```bash
# 检查域名解析
nslookup your-domain.com
ping your-domain.com
```

## 11. 监控和日志

### 11.1 系统监控

```bash
# 查看系统资源
htop

# 查看磁盘使用
df -h

# 查看内存使用
free -h

# 查看网络连接
netstat -tulpn
```

### 11.2 应用日志

```bash
# PM2日志
pm2 logs

# Nginx日志
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log

# 系统日志
sudo journalctl -u nginx -f
```

## 12. 自动化部署脚本

### 12.1 创建部署脚本

```bash
vim deploy.sh
```

### 12.2 部署脚本内容

```bash
#!/bin/bash

# 部署脚本
set -e

echo "开始部署..."

# 拉取最新代码
git pull origin main

# 安装依赖
npm install

# 构建项目
npm run build

# 重启API服务
pm2 restart your-app-api

# 重启Nginx
sudo systemctl reload nginx

echo "部署完成！"
```

### 12.3 设置执行权限

```bash
chmod +x deploy.sh
```

## 13. 备份策略

### 13.1 数据库备份

```bash
# 创建备份脚本
vim backup.sh

#!/bin/bash
DATE=$(date +"%Y%m%d_%H%M%S")
BACKUP_DIR="/home/deploy/backups"
mkdir -p $BACKUP_DIR

# 备份项目文件
tar -czf $BACKUP_DIR/project_$DATE.tar.gz /home/deploy/your-project

# 如果使用本地PostgreSQL
# pg_dump -U your_app_user -h localhost your_app_db > $BACKUP_DIR/db_$DATE.sql

# 删除7天前的备份
find $BACKUP_DIR -name "*.tar.gz" -mtime +7 -delete
find $BACKUP_DIR -name "*.sql" -mtime +7 -delete

echo "备份完成：$DATE"
```

### 13.2 设置定时备份

```bash
# 设置定时任务
crontab -e

# 每天凌晨2点备份
0 2 * * * /home/deploy/backup.sh
```

## 14. 常见问题解决

### 14.1 端口被占用

```bash
# 查看端口占用
sudo netstat -tulpn | grep :3000

# 杀死进程
sudo kill -9 PID
```

### 14.2 权限问题

```bash
# 修改文件权限
sudo chown -R deploy:deploy /home/deploy/your-project
sudo chmod -R 755 /home/deploy/your-project
```

### 14.3 内存不足

```bash
# 创建交换文件
sudo fallocate -l 2G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile

# 永久启用
echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
```

### 14.4 Nginx配置错误

```bash
# 测试配置
sudo nginx -t

# 查看错误日志
sudo tail -f /var/log/nginx/error.log
```

## 15. 性能优化

### 15.1 Nginx优化

```nginx
# 在/etc/nginx/nginx.conf中添加
worker_processes auto;
worker_connections 1024;

# 启用gzip压缩
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_types text/plain text/css application/json application/javascript text/xml application/xml;
```

### 15.2 Node.js优化

```bash
# 设置Node.js内存限制
export NODE_OPTIONS="--max-old-space-size=1024"
```

## 16. 安全加固

### 16.1 配置自动安全更新
```bash
# 安装自动更新工具
sudo apt install -y unattended-upgrades apt-listchanges

# 配置自动更新
sudo dpkg-reconfigure -plow unattended-upgrades

# 编辑自动更新配置
sudo vim /etc/apt/apt.conf.d/50unattended-upgrades

# 确保以下配置启用：
# Unattended-Upgrade::Automatic-Reboot "false";
# Unattended-Upgrade::Automatic-Reboot-Time "02:00";
# Unattended-Upgrade::Remove-Unused-Dependencies "true";

# 启用自动更新服务
sudo systemctl enable unattended-upgrades
sudo systemctl start unattended-upgrades

# 检查自动更新状态
sudo systemctl status unattended-upgrades

# 查看更新日志
sudo tail -f /var/log/unattended-upgrades/unattended-upgrades.log
```

### 16.2 安装和配置fail2ban
```bash
# 安装fail2ban
sudo apt update
sudo apt install -y fail2ban

# 启动并启用服务
sudo systemctl start fail2ban
sudo systemctl enable fail2ban

# 创建本地配置文件
sudo cp /etc/fail2ban/jail.conf /etc/fail2ban/jail.local

# 编辑配置文件
sudo vim /etc/fail2ban/jail.local

# 添加以下配置：
[DEFAULT]
bantime = 3600
findtime = 600
maxretry = 3
ignoreip = 127.0.0.1/8 ::1

[sshd]
enabled = true
port = ssh
filter = sshd
logpath = /var/log/auth.log
maxretry = 3
bantime = 3600

[nginx-http-auth]
enabled = true
filter = nginx-http-auth
logpath = /var/log/nginx/error.log

# 重启fail2ban服务
sudo systemctl restart fail2ban

# 检查fail2ban状态
sudo fail2ban-client status
sudo fail2ban-client status sshd

# 查看被封禁的IP
sudo fail2ban-client get sshd banned
```

## 总结

本指南专门针对Ubuntu 22.04 LTS系统，提供了完整的项目部署流程。按照这些步骤，您可以成功将项目部署到阿里云服务器上。

## 🚀 快速部署检查清单

### 系统准备
- [ ] 确认Ubuntu 22.04 LTS系统
- [ ] 更新系统：`sudo apt update && sudo apt upgrade -y`
- [ ] 创建deploy用户并配置sudo权限
- [ ] 配置SSH密钥登录

### 安全配置
- [ ] 配置UFW防火墙
- [ ] 优化SSH安全设置
- [ ] 安装配置fail2ban
- [ ] 启用自动安全更新

### 环境安装
- [ ] 安装Node.js 18.x LTS
- [ ] 安装Docker和Docker Compose
- [ ] 安装Nginx
- [ ] 安装PM2进程管理器

### 项目部署
- [ ] 上传项目代码
- [ ] 配置环境变量(.env)
- [ ] 安装项目依赖
- [ ] 构建项目
- [ ] 配置Nginx反向代理
- [ ] 启动应用服务

### 域名和SSL
- [ ] 配置域名解析
- [ ] 安装SSL证书
- [ ] 验证HTTPS访问

### 监控和维护
- [ ] 配置日志监控
- [ ] 设置自动备份
- [ ] 测试所有功能

## 🔧 常用运维命令

```bash
# 系统状态检查
sudo systemctl status nginx
sudo systemctl status docker
pm2 status

# 查看日志
sudo tail -f /var/log/nginx/error.log
pm2 logs
sudo journalctl -u nginx -f

# 防火墙管理
sudo ufw status
sudo fail2ban-client status

# 系统资源监控
htop
df -h
free -h
```

## ⚠️ 重要提醒

1. **定期备份数据** - 设置自动备份脚本
2. **监控服务器性能** - 使用htop、df等工具
3. **及时更新系统** - 已配置自动安全更新
4. **检查安全日志** - 定期查看fail2ban和系统日志
5. **测试备份恢复** - 确保备份可用

## 🆘 故障排除

如遇问题，请按以下顺序排查：
1. 检查服务状态：`sudo systemctl status service_name`
2. 查看错误日志：`sudo journalctl -u service_name -f`
3. 检查防火墙设置：`sudo ufw status`
4. 验证配置文件语法：`sudo nginx -t`
5. 重启相关服务：`sudo systemctl restart service_name`

部署完成后，您的应用将通过域名安全访问，所有服务都已优化配置，可以稳定运行。