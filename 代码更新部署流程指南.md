# 代码更新部署流程指南 (小白版)

本指南将帮助你从本地开发到服务器部署的完整流程，每一步都有详细说明。

## 📋 前置准备

### 1. 确保本地环境正常
- 确保本地项目能正常运行 (`npm run dev`)
- 确保登录注册功能正常
- 确保没有报错

### 2. 准备Git环境
如果还没有配置Git，请先配置：
```bash
# 配置用户信息（只需要配置一次）
git config --global user.name "你的名字"
git config --global user.email "你的邮箱"
```

## 🚀 完整部署流程

### 步骤1：本地代码提交

#### 1.1 检查代码状态
```bash
# 查看哪些文件被修改了
git status
```

#### 1.2 添加修改的文件
```bash
# 添加所有修改的文件
git add .

# 或者添加特定文件
git add src/components/Login.tsx
git add vite.config.ts
```

#### 1.3 提交代码
```bash
# 提交代码并添加说明
git commit -m "修复登录功能和API配置"

# 说明要简洁明了，描述你做了什么修改
```

#### 1.4 推送到远程仓库
```bash
# 推送到主分支
git push origin main

# 如果是其他分支，替换main为你的分支名
```

### 步骤2：连接服务器

```bash
# 连接到阿里云服务器
ssh root@139.196.228.41

# 输入密码后进入服务器
```

### 步骤3：服务器端更新代码

#### 3.1 进入项目目录
```bash
# 进入项目目录（根据你的实际路径调整）
cd /root/短视频文案助手

# 或者
cd /var/www/video-script-helper
```

#### 3.2 拉取最新代码
```bash
# 拉取最新代码
git pull origin main

# 如果有冲突，按提示解决
```

#### 3.3 安装新依赖（如果有的话）
```bash
# 安装前端依赖
npm install

# 如果后端有新依赖
cd api
npm install
cd ..
```

### 步骤4：重新构建前端

```bash
# 构建前端项目
npm run build

# 等待构建完成，确保没有错误
```

### 步骤5：重启服务

#### 5.1 重启Nginx
```bash
# 重启Nginx服务
sudo systemctl restart nginx

# 检查Nginx状态
sudo systemctl status nginx
```

#### 5.2 重启后端API服务

**方法一：如果使用PM2管理**
```bash
# 查看PM2进程
pm2 list

# 重启API服务
pm2 restart video-script-api

# 查看日志
pm2 logs video-script-api
```

**方法二：如果直接运行Node.js**
```bash
# 找到并停止现有进程
ps aux | grep node
kill -9 [进程ID]

# 重新启动API服务
cd api
npm run start &
cd ..
```

### 步骤6：验证部署

#### 6.1 检查服务状态
```bash
# 检查Nginx状态
sudo systemctl status nginx

# 检查API服务是否运行
ps aux | grep node

# 检查端口占用
netstat -tlnp | grep :3000
```

#### 6.2 测试网站功能
1. 打开浏览器访问：`http://139.196.228.41`
2. 测试登录功能
3. 测试注册功能
4. 检查控制台是否有错误

## 🔧 常见问题解决

### 问题1：git pull失败
```bash
# 如果有本地修改冲突
git stash  # 暂存本地修改
git pull origin main
git stash pop  # 恢复本地修改
```

### 问题2：npm run build失败
```bash
# 清除缓存重试
npm cache clean --force
rm -rf node_modules
npm install
npm run build
```

### 问题3：API服务启动失败
```bash
# 检查端口是否被占用
netstat -tlnp | grep :3000

# 如果被占用，杀死进程
kill -9 [进程ID]

# 重新启动
cd api
npm run start
```

### 问题4：Nginx配置问题
```bash
# 测试Nginx配置
sudo nginx -t

# 如果配置有误，编辑配置文件
sudo nano /etc/nginx/sites-available/default

# 重新加载配置
sudo systemctl reload nginx
```

## 📝 快速命令清单

### 本地操作
```bash
# 1. 检查状态
git status

# 2. 提交代码
git add .
git commit -m "描述修改内容"
git push origin main
```

### 服务器操作
```bash
# 1. 连接服务器
ssh root@139.196.228.41

# 2. 更新代码
cd /root/短视频文案助手  # 根据实际路径调整
git pull origin main

# 3. 重新构建
npm install
npm run build

# 4. 重启服务
sudo systemctl restart nginx
pm2 restart video-script-api  # 或其他重启方式

# 5. 检查状态
sudo systemctl status nginx
ps aux | grep node
```

## ⚠️ 重要提醒

1. **备份重要数据**：部署前建议备份数据库
2. **测试环境**：重要更新建议先在测试环境验证
3. **回滚准备**：记录上一个稳定版本的commit ID，以便回滚
4. **监控日志**：部署后密切关注错误日志
5. **用户通知**：如果是重大更新，提前通知用户

## 🆘 紧急回滚

如果部署后发现严重问题，可以快速回滚：

```bash
# 1. 查看提交历史
git log --oneline

# 2. 回滚到上一个稳定版本
git reset --hard [上一个稳定的commit ID]

# 3. 重新构建和重启
npm run build
sudo systemctl restart nginx
pm2 restart video-script-api
```

---

**记住**：每次部署都要按顺序执行，不要跳过任何步骤！如果遇到问题，先查看日志，再根据错误信息解决。