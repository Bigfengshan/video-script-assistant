# 系统运维管理指南

## 目录
- [1. 添加系统管理员](#1-添加系统管理员)
- [2. 数据库管理和维护](#2-数据库管理和维护)
- [3. 用户权限管理](#3-用户权限管理)
- [4. 系统监控和故障排除](#4-系统监控和故障排除)
- [5. 安全最佳实践](#5-安全最佳实践)
- [6. 备份和恢复流程](#6-备份和恢复流程)

---

## 1. 添加系统管理员

### 1.1 通过Supabase控制台添加管理员（推荐）

#### 步骤1：登录Supabase控制台
1. 访问 [https://supabase.com](https://supabase.com)
2. 登录你的Supabase账号
3. 选择对应的项目

#### 步骤2：打开SQL编辑器
1. 在左侧菜单中点击 "SQL Editor"
2. 点击 "New query" 创建新查询

#### 步骤3：执行管理员创建SQL

```sql
-- 创建管理员账户
INSERT INTO users (
  id,
  email,
  password_hash,
  role,
  created_at,
  updated_at
) VALUES (
  gen_random_uuid(),
  'admin@yourdomain.com',  -- 修改为你的管理员邮箱
  '$2b$10$rQZ8kHp0rQZ8kHp0rQZ8kOeKvKvKvKvKvKvKvKvKvKvKvKvKvKvKv',  -- 默认密码：admin123
  'admin',
  NOW(),
  NOW()
);

-- 为管理员创建订阅记录
INSERT INTO subscriptions (
  id,
  user_id,
  plan_type,
  status,
  start_date,
  end_date,
  created_at,
  updated_at
) VALUES (
  gen_random_uuid(),
  (SELECT id FROM users WHERE email = 'admin@yourdomain.com'),
  'premium',
  'active',
  NOW(),
  NOW() + INTERVAL '1 year',
  NOW(),
  NOW()
);
```

#### 步骤4：验证管理员创建

```sql
-- 查询管理员账户
SELECT id, email, role, created_at FROM users WHERE role = 'admin';

-- 查询管理员订阅
SELECT s.*, u.email 
FROM subscriptions s 
JOIN users u ON s.user_id = u.id 
WHERE u.role = 'admin';
```

### 1.2 自定义管理员密码

如果需要设置自定义密码，可以使用以下方法生成密码哈希：

#### 方法1：使用Node.js生成（推荐）

```javascript
const bcrypt = require('bcrypt');

// 生成密码哈希
const password = 'your_custom_password';
const saltRounds = 10;

bcrypt.hash(password, saltRounds, (err, hash) => {
  if (err) {
    console.error('Error generating hash:', err);
  } else {
    console.log('Password hash:', hash);
  }
});
```

#### 方法2：使用在线工具
1. 访问 [https://bcrypt-generator.com/](https://bcrypt-generator.com/)
2. 输入你的密码
3. 选择 "Rounds: 10"
4. 复制生成的哈希值

### 1.3 默认管理员信息

- **邮箱**: admin@test.com
- **密码**: admin123
- **角色**: admin

⚠️ **安全提醒**：首次登录后请立即修改默认密码！

---

## 2. 数据库管理和维护

### 2.1 数据库连接信息

项目使用Supabase作为数据库，连接信息存储在`.env`文件中：

```env
SUPABASE_URL=your_supabase_url
SUPABASE_ANON_KEY=your_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key
```

### 2.2 数据库表结构

#### 主要表说明

1. **users** - 用户表
   - `id`: 用户唯一标识
   - `email`: 用户邮箱
   - `password_hash`: 密码哈希
   - `role`: 用户角色（user/admin）
   - `created_at`: 创建时间
   - `updated_at`: 更新时间

2. **subscriptions** - 订阅表
   - `id`: 订阅唯一标识
   - `user_id`: 关联用户ID
   - `plan_type`: 订阅类型
   - `status`: 订阅状态
   - `start_date`: 开始日期
   - `end_date`: 结束日期

3. **ai_agents** - AI代理表
   - `id`: 代理唯一标识
   - `user_id`: 创建者ID
   - `name`: 代理名称
   - `description`: 代理描述
   - `config`: 配置信息

### 2.3 常用数据库查询

#### 用户管理查询

```sql
-- 查看所有用户
SELECT id, email, role, created_at FROM users ORDER BY created_at DESC;

-- 查看活跃用户（有订阅的用户）
SELECT u.email, u.role, s.plan_type, s.status
FROM users u
JOIN subscriptions s ON u.id = s.user_id
WHERE s.status = 'active';

-- 查看用户统计
SELECT 
  COUNT(*) as total_users,
  COUNT(CASE WHEN role = 'admin' THEN 1 END) as admin_count,
  COUNT(CASE WHEN role = 'user' THEN 1 END) as user_count
FROM users;
```

#### 订阅管理查询

```sql
-- 查看所有订阅
SELECT s.*, u.email
FROM subscriptions s
JOIN users u ON s.user_id = u.id
ORDER BY s.created_at DESC;

-- 查看即将到期的订阅
SELECT s.*, u.email
FROM subscriptions s
JOIN users u ON s.user_id = u.id
WHERE s.end_date <= NOW() + INTERVAL '7 days'
AND s.status = 'active';
```

### 2.4 数据库维护任务

#### 定期清理任务

```sql
-- 清理过期的会话（如果有session表）
DELETE FROM sessions WHERE expires_at < NOW();

-- 清理软删除的记录（如果使用软删除）
DELETE FROM users WHERE deleted_at IS NOT NULL AND deleted_at < NOW() - INTERVAL '30 days';
```

#### 性能优化

```sql
-- 分析表统计信息
ANALYZE users;
ANALYZE subscriptions;
ANALYZE ai_agents;

-- 检查索引使用情况
SELECT schemaname, tablename, indexname, idx_tup_read, idx_tup_fetch
FROM pg_stat_user_indexes
ORDER BY idx_tup_read DESC;
```

---

## 3. 用户权限管理

### 3.1 角色权限说明

#### 管理员权限 (admin)
- 查看所有用户信息
- 管理用户订阅
- 访问系统统计数据
- 管理AI代理配置
- 系统设置管理

#### 普通用户权限 (user)
- 管理个人资料
- 创建和管理个人AI代理
- 使用订阅服务
- 查看个人使用统计

### 3.2 权限检查SQL

```sql
-- 检查用户权限
SELECT 
  u.email,
  u.role,
  CASE 
    WHEN u.role = 'admin' THEN '管理员'
    WHEN u.role = 'user' THEN '普通用户'
    ELSE '未知角色'
  END as role_name,
  s.plan_type,
  s.status as subscription_status
FROM users u
LEFT JOIN subscriptions s ON u.id = s.user_id
WHERE u.email = 'user@example.com';
```

### 3.3 修改用户权限

```sql
-- 将用户提升为管理员
UPDATE users 
SET role = 'admin', updated_at = NOW() 
WHERE email = 'user@example.com';

-- 将管理员降级为普通用户
UPDATE users 
SET role = 'user', updated_at = NOW() 
WHERE email = 'admin@example.com';
```

---

## 4. 系统监控和故障排除

### 4.1 服务状态检查

#### 检查后端API服务

```bash
# 检查Node.js进程
ps aux | grep node

# 检查端口占用
netstat -tlnp | grep :3000

# 使用PM2检查服务状态
pm2 status
pm2 logs video-script-api --lines 50
```

#### 检查Nginx状态

```bash
# 检查Nginx状态
sudo systemctl status nginx

# 检查Nginx配置
sudo nginx -t

# 重启Nginx
sudo systemctl restart nginx
```

### 4.2 日志监控

#### 应用日志

```bash
# 查看PM2日志
pm2 logs video-script-api --lines 100

# 实时监控日志
pm2 logs video-script-api --follow

# 查看错误日志
pm2 logs video-script-api --err
```

#### 系统日志

```bash
# 查看系统日志
sudo journalctl -u nginx -f

# 查看最近的错误
sudo journalctl --priority=err --since="1 hour ago"
```

### 4.3 常见问题排查

#### 问题1：登录失败

**排查步骤**：
1. 检查数据库连接
2. 验证用户密码哈希
3. 检查JWT配置
4. 查看API日志

```sql
-- 检查用户是否存在
SELECT id, email, role FROM users WHERE email = 'user@example.com';

-- 检查密码哈希格式
SELECT email, LENGTH(password_hash) as hash_length 
FROM users WHERE email = 'user@example.com';
```

#### 问题2：API请求失败

**排查步骤**：
1. 检查Nginx代理配置
2. 验证后端服务运行状态
3. 检查防火墙设置
4. 测试API端点

```bash
# 测试API端点
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"password"}'
```

#### 问题3：数据库连接失败

**排查步骤**：
1. 检查环境变量配置
2. 验证Supabase项目状态
3. 测试数据库连接
4. 检查网络连接

```bash
# 检查环境变量
echo $SUPABASE_URL
echo $SUPABASE_ANON_KEY
```

---

## 5. 安全最佳实践

### 5.1 密码安全

- 使用强密码策略（至少8位，包含大小写字母、数字、特殊字符）
- 定期更换管理员密码
- 使用bcrypt进行密码哈希（saltRounds >= 10）
- 禁用默认账户或修改默认密码

### 5.2 API安全

- 使用HTTPS加密传输
- 实施API速率限制
- 验证所有输入参数
- 使用JWT进行身份验证
- 定期轮换JWT密钥

### 5.3 数据库安全

- 启用行级安全策略（RLS）
- 使用最小权限原则
- 定期备份数据库
- 监控异常查询
- 加密敏感数据

### 5.4 服务器安全

```bash
# 更新系统包
sudo apt update && sudo apt upgrade -y

# 配置防火墙
sudo ufw enable
sudo ufw allow 22/tcp
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# 禁用root SSH登录
sudo sed -i 's/PermitRootLogin yes/PermitRootLogin no/' /etc/ssh/sshd_config
sudo systemctl restart ssh
```

### 5.5 环境变量安全

- 不要在代码中硬编码敏感信息
- 使用`.env`文件管理环境变量
- 确保`.env`文件不被提交到版本控制
- 定期轮换API密钥

---

## 6. 备份和恢复流程

### 6.1 数据库备份

#### Supabase自动备份
Supabase提供自动备份功能，可在控制台中查看和管理：

1. 登录Supabase控制台
2. 选择项目
3. 进入"Settings" > "Database"
4. 查看"Backups"部分

#### 手动备份

```bash
# 使用pg_dump备份（需要数据库直连权限）
pg_dump -h your-db-host -U postgres -d your-database > backup_$(date +%Y%m%d_%H%M%S).sql
```

#### 导出特定表数据

```sql
-- 导出用户数据
COPY (SELECT * FROM users) TO '/tmp/users_backup.csv' WITH CSV HEADER;

-- 导出订阅数据
COPY (SELECT * FROM subscriptions) TO '/tmp/subscriptions_backup.csv' WITH CSV HEADER;
```

### 6.2 代码备份

```bash
# 创建代码备份
tar -czf backup_code_$(date +%Y%m%d_%H%M%S).tar.gz \
  --exclude=node_modules \
  --exclude=.git \
  --exclude=dist \
  /path/to/your/project

# 备份到远程服务器
rsync -avz --exclude=node_modules /path/to/your/project/ user@backup-server:/backups/
```

### 6.3 配置文件备份

```bash
# 备份Nginx配置
sudo cp /etc/nginx/sites-available/default /backup/nginx_config_$(date +%Y%m%d).conf

# 备份环境变量
cp .env .env.backup.$(date +%Y%m%d)

# 备份PM2配置
pm2 save
cp ~/.pm2/dump.pm2 /backup/pm2_config_$(date +%Y%m%d).json
```

### 6.4 恢复流程

#### 数据库恢复

```sql
-- 从备份恢复数据（谨慎操作）
-- 1. 先备份当前数据
-- 2. 清空相关表
-- 3. 导入备份数据

-- 示例：恢复用户数据
TRUNCATE users CASCADE;
COPY users FROM '/tmp/users_backup.csv' WITH CSV HEADER;
```

#### 代码恢复

```bash
# 从备份恢复代码
tar -xzf backup_code_20231201_120000.tar.gz -C /path/to/restore/

# 重新安装依赖
cd /path/to/restore/
npm install

# 重新构建项目
npm run build

# 重启服务
pm2 restart all
```

### 6.5 备份策略建议

- **每日备份**：自动备份数据库和关键配置
- **每周备份**：完整代码和系统配置备份
- **版本发布前**：创建完整系统快照
- **保留策略**：保留最近30天的每日备份，最近12周的周备份

---

## 附录

### A. 常用命令速查

```bash
# 服务管理
pm2 status                    # 查看PM2服务状态
pm2 restart video-script-api  # 重启API服务
sudo systemctl restart nginx  # 重启Nginx

# 日志查看
pm2 logs video-script-api --lines 50  # 查看API日志
sudo journalctl -u nginx -f           # 实时查看Nginx日志

# 系统监控
top                           # 查看系统资源使用
df -h                         # 查看磁盘使用情况
free -h                       # 查看内存使用情况
```

### B. 紧急联系信息

- **系统管理员**: [填写联系方式]
- **数据库管理员**: [填写联系方式]
- **技术支持**: [填写联系方式]

### C. 相关文档链接

- [代码更新部署流程指南](./代码更新部署流程指南.md)
- [阿里云服务器部署指南](./阿里云服务器部署指南.md)
- [Supabase官方文档](https://supabase.com/docs)
- [PM2官方文档](https://pm2.keymetrics.io/docs/)

---

**最后更新时间**: $(date +%Y-%m-%d)
**文档版本**: v1.0
**维护人员**: [填写维护人员信息]